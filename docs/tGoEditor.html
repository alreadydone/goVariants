<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>viewer/editor for Toroidal Go</title>

</head>

<body>
<!-- 
    <script type="text/javascript" language="JavaScript" src="../lib/goboardmin.js"></script>
    </script> -->

     <script type="text/javascript" language="JavaScript" src="
        https://cdn.rawgit.com/IlyaKirillov/GoProject/c20084d83c01b394cbf2f19b92b114feebb7fb8c/WebBuilds/goboardmin.js"></script> 
        
    <script type="text/javascript" language="JavaScript" src="https://cdn.rawgit.com/goplayerjuggler/goVariants/55fa838f86a15f40220135cb208b0bce3798740e/transformer/dist/transformer.min.js"></script>

    <!-- <script type="text/javascript" language="JavaScript" src="../dist/transformer.min.js"></script> -->
    <!-- <script type="text/javascript" language="JavaScript" src="https://cdn.rawgit.com/goplayerjuggler/goVariants/transformer/dist/transformer.min.js"></script> -->

    <div>

        Paste SGF for a game of toroidal Go, aka t-Go, (e.g. from Little Golem) in the box below, and then push the button to view the game! This page can also be used to play t-Go and to create SGF for t-Go with variations and comments; it’s provided on an “as-is” basis. 
        <br />
        <label for="sgfIn">T-Go SGF:</label>
        <textarea id="sgfIn" rows="3"></textarea>
        <label for="sgfOut">Transformed SGF:</label>
        <textarea id="sgfOut" rows="3"></textarea>
        <br />
        <input type="button" id="goButton" value="show board (from t-Go SGF)" />
        <input type="button" id="updateButton" style="display: none" value="update all (t-Go SGF and board) (from board)" />
        <label for="wraparoundSelect">number of wraparound lines to add:</label>
        <select id="wraparoundSelect">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>

        </select>
        <label for="addComments">add comments:</label>
        <input type="checkbox" id="addComments" checked>
        <label for="wraparoundBorderSelect">Type of border for wraparound:</label>
        <select id="wraparoundBorderSelect">
            <option value="0">No border</option>
            <option value="1">Box drawing symbols</option>
            <option value="2" selected>Coordinates</option>
        </select>

    </div>

    <table id="viewerControls" title="panning" style="display:none">
        <tr>
            <td colspan="2" style="text-align: center">
                <input type="button" id="btU" class="go-variants-panning" value="↑" />
            </td>
            <td rowspan="4" style="vertical-align: middle">“Panning”
                <p> Use the buttons to the left to move the “centre” of the board.</p>
            </td>
        </tr>
        <tr>
            <td>
                <input type="button" id="btL" class="go-variants-panning" value="←" />
            </td>
            <td>
                <input type="button" id="btR" class="go-variants-panning" value="→" />
            </td>
        </tr>
        <tr>
            <td colspan="2" style="text-align: center">
                <input type="button" id="btD" class="go-variants-panning" value="↓" />
            </td>
        </tr>
        <tr>
            <td colspan="2" style="text-align: center; font-size: small" id="offsetTr">
                panned: [0,0]
            </td>
        </tr>
    </table>
    <!-- </div> -->




    <!--Hacked SGF for a viewer is here: <input type="textarea" id="sgfOut" />-->
    <!--<div id="player" style="width: 700px"></div>-->
    <div id="playerDiv" style="position:relative; height: 75vh;width: 75vw"></div>

    <script type="text/javascript">



        document.viewer = {}
        document.addEventListener('DOMContentLoaded', function () {
            var viewer = document.viewer
            if (viewer.ran) return
            viewer.ran = true//just run this function once


            function showBoard(options) {
                var { tSgf, panningDirection, moveReference, reset } = options
                if (reset || !viewer.offset) viewer.offset = [0, 0]
                if (panningDirection) {
                    var right = viewer.offset[0], up = viewer.offset[1]
                    switch (panningDirection) {

                        case "U":
                            {
                                up--
                                break
                            }

                        case "D":
                            {
                                up++
                                break
                            }
                        case "L":
                            {
                                right--
                                break
                            }

                        case "R":
                            {
                                right++
                                break
                            }
                    }
                    viewer.offset = [right, up]
                }

                if (tSgf === undefined || tSgf === null) {
                    tSgf = document.getElementById("sgfIn").value
                }
                if (tSgf === '') {
                    if (!viewer.warnedEmptySgf) {
                        alert('No SGF was entered, so showing a simple sample instead.')
                        viewer.warnedEmptySgf = true
                    }
                    tSgf = '(;GM[1]FF[4]CA[UTF-8]AP[go-variants-transformer]SZ[4]KM[0]HA[0]PB[Black]PW[White]C[Here is small sample game of Toroidal Go. It ends in a seki!];B[ad];W[bd];B[bc];W[ac];B[bb];W[aa];B[ab];W[dd];B[ca];W[cd];B[db];W[dc];B[cc];MA[ba]W[da]C[It’s a seki; neither play should play at X.])'//sample7
                    document.getElementById("sgfIn").value = tSgf
                }
                var wraparound = Number(document.getElementById('wraparoundSelect').value)
                    , wraparoundBorder = Number(document.getElementById('wraparoundBorderSelect').value)
                    , addComments = document.getElementById('addComments').checked
                try {
                    let transformer = go_variants_transformer({ addComments: addComments, projectionSettings: { offset: viewer.offset, wraparound: wraparound, wraparoundMarkersType: wraparoundBorder } })
                    var sgf = transformer.transform(tSgf)
                    document.getElementById("sgfOut").value = sgf
                    document.viewer.transformer = transformer
                }
                catch (e) {
                    alert('an error occurred.')
                }
                if (!panningDirection) {

                    var oGameTree = GoBoardApi.Create_GameTree()
                    document.viewer.oGameTree = oGameTree
                    GoBoardApi.Toggle_Rulers(oGameTree)

                    GoBoardApi.Create_BoardCommentsButtonsNavigator(oGameTree, "playerDiv");
                    
                    // GoBoardApi.Create_EditorVer(oGameTree, "playerDiv");
                    if (moveReference !== undefined)
                        GoBoardApi.Load_Sgf(document.viewer.oGameTree, sgf, undefined, moveReference);
                    else
                        GoBoardApi.Load_Sgf(oGameTree, sgf);

                    window.onresize = function () {
                        GoBoardApi.Update_Size(oGameTree);
                    };

                    document.getElementById('viewerControls').style.display = "inline"
                    document.getElementById('updateButton').style.display = "inline"
                }
                else {
                    var moveReference = GoBoardApi.Get_MoveReference(document.viewer.oGameTree, false)
                    GoBoardApi.Load_Sgf(document.viewer.oGameTree, sgf, undefined, moveReference);
                    document.getElementById('offsetTr').innerHTML = 'panned: [' + viewer.offset[0] + ', ' + viewer.offset[1] + ']'
                }

            }

            function updateVariantSgf() {
                var sgf = GoBoardApi.Save_Sgf(document.viewer.oGameTree)
                var moveReference = GoBoardApi.Get_MoveReference(document.viewer.oGameTree, false)
                // var options = document.viewer.transformer.options
                // options.boardDimensions = options.boardDimensions.map((x) => x - 2 * options.projectionSettings.wraparound) 
                var tSgf = document.viewer.transformer.inverseTransform(sgf)
                document.getElementById("sgfIn").value = tSgf
                showBoard({ tSgf, moveReference })
            }


            document.getElementById('goButton').addEventListener('click', function () {
                showBoard({})
            })

            document.getElementById('updateButton').addEventListener('click', function () {
                updateVariantSgf()
            })

                ;[].forEach.call(document.querySelectorAll('.go-variants-panning'), function (el) {
                    el.addEventListener('click', function (e) {
                        var target = e.target || e.srcElement
                        showBoard({ panningDirection: target.id.substring(2) })
                    })
                });

            document.getElementById('viewerControls').style.display = "none"

        })
        //polyfill
        if (typeof Object.assign != 'function') {
            // Must be writable: true, enumerable: false, configurable: true
            Object.defineProperty(Object, "assign", {
                value: function assign(target, varArgs) { // .length of function is 2
                    'use strict';
                    if (target == null) { // TypeError if undefined or null
                        throw new TypeError('Cannot convert undefined or null to object');
                    }

                    var to = Object(target);

                    for (var index = 1; index < arguments.length; index++) {
                        var nextSource = arguments[index];

                        if (nextSource != null) { // Skip over if undefined or null
                            for (var nextKey in nextSource) {
                                // Avoid bugs when hasOwnProperty is shadowed
                                if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                                    to[nextKey] = nextSource[nextKey];
                                }
                            }
                        }
                    }
                    return to;
                },
                writable: true,
                configurable: true
            });
        }
    </script>
    <p>This viewer for t-Go works using the library
        <a href="https://github.com/goplayerjuggler/goVariants/tree/master/transformer">
            Go-Variants-Transformer</a> on top of Ilya Kirillov’s SGF viewer.</p>
</body>

</html>